name: testoperator dispatch

on:
  workflow_dispatch:
    inputs:
      test_files_path:
        description: 'path to load test files to dispatch'
        required: true
        type: string
      workflow_type:
        description: 'the workflow to execute (bench, throughput, load, etc)'
        required: true
        default: 'bench'
        type: choice
        options:
          - 'bench'
          - 'load'
          - 'throughput'

jobs:
  dispatch-tests:
    name: Dispatch tests
    runs-on: spiceai-runners
    steps:
      - uses: actions/checkout@v4

      - name: Install MinIO
        run: |
          sudo apt update && sudo apt install wget -y
          sudo wget https://dl.min.io/client/mc/release/linux-amd64/mc -O /usr/local/bin/mc
          sudo chmod +x /usr/local/bin/mc
          mc alias set spice-minio ${{ secrets.MINIO_ENDPOINT }} ${{ secrets.MINIO_ACCESS_KEY }} ${{ secrets.MINIO_SECRET_KEY }}

      - name: Find the latest built spiced commit
        run: |
          commit_hashes=($(git log --pretty=format:"%H" -n 10))

          for hash in "${commit_hashes[@]}"; do
            echo "Checking $hash in MinIO"
            if mc stat spice-minio/artifacts/spiced/linux-x86_64/$hash/spiced_models_linux_x86_64.tar.gz; then
              echo "Found $hash in MinIO"
              echo "SPICED_COMMIT=$hash" >> $GITHUB_ENV
              exit 0
            fi
          done

          echo "Could not find any recently built spiced commit in MinIO"
          exit 1

      - name: Download spiced from MinIO
        run: |
          mc cp spice-minio/artifacts/spiced/linux-x86_64/$SPICED_COMMIT/spiced_models_linux_x86_64.tar.gz spiced_models_linux_x86_64.tar.gz
          tar -xzf spiced_models_linux_x86_64.tar.gz
          sudo cp ./spiced /usr/local/bin/spiced